{% extends 'base.html' %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
  <article aria-labelledby="product-name">
    <h1 id="product-name">{{ product.name }}</h1>
    <div id="product-description" data-text="{{ product.text_description|escapejs }}">
        {{ product.text_description|linebreaks }}
    </div>
  </article>

  <div role="toolbar" aria-label="Audio controls">
      <button id="play-pause-btn" class="btn">Play Audio</button>
  </div>

  <script>
    // Architectural Decision:
    // The Web Speech API (SpeechSynthesis) is used for TTS. This is a client-side technology,
    // which means no server resources are consumed for generating audio, and it works offline
    // after the page has loaded. This is a significant advantage over server-side TTS.
    // The script is designed to be robust, checking for API availability and handling various
    // states like playing, paused, and ended.

    document.addEventListener('DOMContentLoaded', () => {
        const descriptionDiv = document.getElementById('product-description');
        const textToSpeak = descriptionDiv.getAttribute('data-text');
        const playPauseBtn = document.getElementById('play-pause-btn');
        
        // Check if the browser supports the SpeechSynthesis API.
        if ('speechSynthesis' in window) {
            const synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance(`You've scanned an accessible audio label. ${textToSpeak}`);
            
            // Set a fixed, slower speech rate for better clarity.
            utterance.rate = 0.8; // Values between 0.1 and 10 are typical. 1 is default.

            // Automatically play the audio when the page loads.
            // A timeout is added to help ensure the voice synthesis is ready,
            // which can sometimes be an issue on mobile browsers.
            setTimeout(() => {
                synth.speak(utterance);
                playPauseBtn.textContent = 'Pause Audio';
            }, 500);


            playPauseBtn.addEventListener('click', () => {
                if (synth.paused) {
                    synth.resume();
                    playPauseBtn.textContent = 'Pause Audio';
                } else if (synth.speaking) {
                    synth.pause();
                    playPauseBtn.textContent = 'Resume Audio';
                } else {
                    // If speech has ended, start it again.
                    synth.speak(utterance);
                    playPauseBtn.textContent = 'Pause Audio';
                }
            });

            utterance.onend = () => {
                // For the blind user flow, automatically return to the scanner.
                window.location.href = "{% url 'scan_beacon' %}";
            };

        } else {
            // If the browser does not support the API, hide the controls and inform the user.
            console.error("Sorry, your browser does not support the Web Speech API.");
            playPauseBtn.style.display = 'none';
        }
    });
  </script>
{% endblock %}
