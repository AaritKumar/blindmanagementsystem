{% extends 'base.html' %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
  <article aria-labelledby="product-name">
    <h1 id="product-name">{{ product.name }}</h1>
    <div id="product-description" data-text="{{ product.text_description|escapejs }}">
        {{ product.text_description|linebreaks }}
    </div>
  </article>

  <div role="toolbar" aria-label="Audio controls">
      <button id="play-pause-btn" class="btn">Play Audio</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const descriptionDiv = document.getElementById('product-description');
        const textToSpeak = descriptionDiv.getAttribute('data-text');
        const playPauseBtn = document.getElementById('play-pause-btn');
        
        if ('speechSynthesis' in window) {
            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(`You've scanned an accessible audio label. ${textToSpeak}`);
            utterance.rate = 0.8;

            const speakText = () => {
                // A common mobile browser bug requires a "kick" to resume speech synthesis
                // if it was paused from a previous page.
                if (synth.paused) {
                    synth.resume();
                }
                if (!synth.speaking) {
                    synth.speak(utterance);
                    playPauseBtn.textContent = 'Pause Audio';
                }
            };

            // This is the robust way to handle speech synthesis. The 'voiceschanged' event
            // signals that the TTS engine is fully initialized and ready to speak.
            if (synth.getVoices().length !== 0) {
                // If voices are already loaded, speak after a brief, safe delay.
                setTimeout(speakText, 200);
            } else {
                // Otherwise, wait for the signal from the browser.
                synth.onvoiceschanged = speakText;
            }

            playPauseBtn.addEventListener('click', () => {
                if (synth.paused) {
                    synth.resume();
                    playPauseBtn.textContent = 'Pause Audio';
                } else if (synth.speaking) {
                    synth.pause();
                    playPauseBtn.textContent = 'Resume Audio';
                } else {
                    speakText(); // Allow re-playing if it has finished
                }
            });

            utterance.onend = () => {
                // Automatically return to the scanner for a seamless multi-scan experience.
                window.location.href = "{% url 'scan_beacon' %}";
            };

        } else {
            console.error("Sorry, your browser does not support the Web Speech API.");
            playPauseBtn.style.display = 'none';
        }
    });
  </script>
{% endblock %}
