{% extends 'base.html' %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
  <article aria-labelledby="product-name">
    <h1 id="product-name">{{ product.name }}</h1>
    <div id="product-description" data-text="{{ product.text_description|escapejs }}">
        {{ product.text_description|linebreaks }}
    </div>
  </article>

  <div role="toolbar" aria-label="Audio controls" style="margin-top: 2rem;">
      <button id="play-pause-btn" class="choice-btn" style="width: 100%; padding: 1.5rem; font-size: 1.5rem;">Play Audio</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const descriptionDiv = document.getElementById('product-description');
        const textToSpeak = descriptionDiv.getAttribute('data-text');
        const playPauseBtn = document.getElementById('play-pause-btn');
        
        if ('speechSynthesis' in window) {
            const synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance(`You've scanned an accessible audio label. ${textToSpeak}`);
            
            utterance.rate = 0.8; 

            playPauseBtn.addEventListener('click', () => {
                // On first click, start the speech. On subsequent clicks, toggle play/pause.
                if (synth.paused) {
                    synth.resume();
                    playPauseBtn.textContent = 'Pause Audio';
                } else if (synth.speaking) {
                    synth.pause();
                    playPauseBtn.textContent = 'Resume Audio';
                } else {
                    synth.speak(utterance);
                    playPauseBtn.textContent = 'Pause Audio';
                }
            });

            utterance.onend = () => {
                // Automatically return to the scanner for a seamless multi-scan experience.
                window.location.href = "{% url 'scan_beacon' %}";
            };

        } else {
            console.error("Sorry, your browser does not support the Web Speech API.");
            playPauseBtn.style.display = 'none';
        }
    });
  </script>
{% endblock %}
