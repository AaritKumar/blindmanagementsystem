{% extends 'base.html' %}

{% block title %}Scan Mode{% endblock %}

{% block content %}
  <h1>Scan QR Code</h1>
  <p>This page uses your camera to scan for a QR code. When a QR code is found, you will be redirected to the corresponding page.</p>
  <div id="scanner-container" style="position: relative; width: 100%; max-width: 500px; margin: 20px auto; border: 1px solid #ccc;">
    <video id="camera-feed" style="width: 100%; height: auto; display: block;"></video>
    <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
  </div>
  <p id="status-message" role="status" aria-live="polite">Attempting to start camera...</p>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('camera-feed');
        const scannerContainer = document.getElementById('scanner-container');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const statusMessage = document.getElementById('status-message');
        
        let scanning = false;
        let stream = null;
        let audioCtx = null;
        let lastBeepTime = 0;

        function playSound(freq, duration) {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        function tick() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    // --- Intelligent Beacon Logic ---
                    const loc = code.location;
                    drawLine(loc.topLeftCorner, loc.topRightCorner, "#FF3B58");
                    drawLine(loc.topRightCorner, loc.bottomRightCorner, "#FF3B58");
                    drawLine(loc.bottomRightCorner, loc.bottomLeftCorner, "#FF3B58");
                    drawLine(loc.bottomLeftCorner, loc.topLeftCorner, "#FF3B58");
                    
                    // Calculate the size of the QR code in the frame.
                    const qrWidth = Math.abs(loc.topRightCorner.x - loc.topLeftCorner.x);
                    const qrHeight = Math.abs(loc.bottomLeftCorner.y - loc.topLeftCorner.y);
                    const qrArea = qrWidth * qrHeight;
                    const canvasArea = canvasElement.width * canvasElement.height;
                    const percentArea = qrArea / canvasArea;

                    // If the QR code is large enough, redirect.
                    if (percentArea > 0.1) { // 10% of the view
                        statusMessage.textContent = "QR Code detected! Redirecting...";
                        playSound(1200, 0.2); // Success sound
                        window.location.href = code.data;
                        stopScanner();
                        return;
                    }

                    // Adjust beep interval based on distance (size). Closer = faster beeps.
                    const now = Date.now();
                    const maxInterval = 1500; // Slower interval when far away
                    const minInterval = 200;  // Faster interval when close
                    const interval = maxInterval - (maxInterval - minInterval) * Math.min(percentArea * 10, 1); // Scale interval by area

                    if (now - lastBeepTime > interval) {
                        playSound(880, 0.1); // Beacon sound
                        lastBeepTime = now;
                    }

                }
            }
            requestAnimationFrame(tick);
        }

        function startScanner() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(cameraStream) {
                    stream = cameraStream;
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    scanning = true;
                    scannerContainer.style.display = 'block';
                    statusMessage.textContent = 'Scanning for QR code...';
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Error starting camera: ", err);
                    statusMessage.textContent = "Could not start camera. Please grant permission and try again.";
                });
        }

        function stopScanner() {
            scanning = false;
            scannerContainer.style.display = 'none';
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            statusMessage.textContent = 'Scanner deactivated.';
        }

        startScanner();
        window.addEventListener('beforeunload', stopScanner);
    });
  </script>
{% endblock %}
